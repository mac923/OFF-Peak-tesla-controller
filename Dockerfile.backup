# Uproszczony Dockerfile dla Cloud Tesla Monitor BEZ Tesla HTTP Proxy
# Ten build powinien działać stabilnie na Cloud Run

FROM python:3.11-slim

# Zainstaluj wymagane narzędzia systemowe (bez golang i git)
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Ustaw katalog roboczy
WORKDIR /app

# Skopiuj pliki wymagań
COPY requirements_cloud.txt .

# Zainstaluj zależności Python
RUN pip install --no-cache-dir -r requirements_cloud.txt

# Skopiuj główne pliki aplikacji
COPY cloud_tesla_monitor.py .
COPY tesla_controller.py .
COPY tesla_fleet_api_client.py .

# Utwórz puste pliki fallback dla opcjonalnych konfiguracji
RUN touch fleet_tokens.json private-key.pem

# Ustaw zmienne środowiskowe
ENV PYTHONUNBUFFERED=True
ENV PORT=8080
ENV NODE_ENV=production

# Utwórz użytkownika bez uprawnień administratora
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

# Otwórz port dla aplikacji (bez Tesla proxy)
EXPOSE 8080

# Komenda uruchamiająca - bezpośrednio Python (bez proxy)
CMD ["python", "cloud_tesla_monitor.py"] 